# 케어페이 가디언 - 작업 목록 3: 결제 시뮬레이터 및 리스크 분석 시스템

**작업 범위**: 가상 결제 입력, 리스크 스코어링, 판정 로직

---

### 관련 파일
- `app/user/payment-test/page.tsx` - 결제 테스트 페이지
- `components/PaymentSimulator.tsx` - 결제 입력 폼 컴포넌트
- `lib/risk-scoring.ts` - 리스크 계산 로직
- `app/api/transactions/simulate/route.ts` - 결제 시뮬레이션 API
- `types/transaction.types.ts` - 거래 관련 타입

---

## 작업

- [x] 3.0 결제 시뮬레이터 및 리스크 분석 시스템 구현 (Push 단위)
    - [x] 3.1 결제 입력 폼 UI 구현 (커밋 단위)
        - [x] 3.1.1 `PaymentSimulator.tsx` 컴포넌트 생성
        - [x] 3.1.2 입력 필드 구현
            - amount (금액, 1,000 ~ 10,000,000)
            - merchant_name (가맹점명, 1-50자)
            - merchant_category (12개 업종 select)
            - hour (시간, 0-23, 기본값 현재 시간)
        - [x] 3.1.3 React Hook Form + Zod 스키마 설정
        - [x] 3.1.4 실시간 입력 검증 (에러 메시지 표시)
        - [x] 3.1.5 입력 폼 UI 확인
            - [x] 3.1.5.1 테스트 코드 작성 - 폼 유효성 검사 테스트
            - [x] 3.1.5.2 테스트 실행 및 검증
            - [x] 3.1.5.3 오류 수정 (필요 시)
    
    - [x] 3.2 빠른 시나리오 버튼 구현 (커밋 단위)
        - [x] 3.2.1 3개 프리셋 버튼 생성
            - "정상 결제" (5,000원, GS25, 13시)
            - "고액 결제" (3,000,000원, 온라인쇼핑, 14시)
            - "새벽 결제" (500,000원, 온라인쇼핑, 2시)
        - [x] 3.2.2 버튼 클릭 시 폼 자동 채우기
        - [x] 3.2.3 시나리오 버튼 확인
            - [x] 3.2.3.1 테스트 코드 작성 - 프리셋 적용 테스트
            - [x] 3.2.3.2 테스트 실행 및 검증
            - [x] 3.2.3.3 오류 수정 (필요 시)
    
    - [x] 3.3 리스크 스코어링 로직 구현 (커밋 단위)
        - [x] 3.3.1 `lib/risk-scoring.ts` 파일 생성
        - [x] 3.3.2 `calculateRiskScore()` 함수 구현 (PRD 6.1 참조)
            - 금액 리스크 (평균 대비 배수, 최대 40점)
            - 시간 리스크 (새벽/심야 가중치, 최대 30점)
            - 가맹점 리스크 (처음 이용, 최대 15점)
            - 위치 리스크 (향후 구현, 최대 15점)
        - [x] 3.3.3 `getRiskLevel()` 함수 구현
            - critical (81-100), high (61-80), medium (31-60), low (0-30)
        - [x] 3.3.4 리스크 이유 문자열 생성 함수
        - [x] 3.3.5 리스크 스코어링 확인
            - [x] 3.3.5.1 테스트 코드 작성 - 다양한 시나리오별 점수 계산 테스트
            - [x] 3.3.5.2 테스트 실행 및 검증
            - [x] 3.3.5.3 오류 수정 (필요 시)
    
    - [x] 3.4 사용자 패턴 조회 로직 (커밋 단위)
        - [x] 3.4.1 `lib/user-pattern.ts` 파일 생성
        - [x] 3.4.2 `getUserPattern()` 함수 구현
            - 최근 30일 승인된 결제 조회
            - avg_amount, max_amount 계산
            - common_hours, common_categories 추출
        - [x] 3.4.3 패턴 데이터 부족 시 보수적 기본값 반환
        - [x] 3.4.4 사용자 패턴 조회 확인
            - [x] 3.4.4.1 테스트 코드 작성 - 패턴 계산 테스트
            - [x] 3.4.4.2 테스트 실행 및 검증
            - [x] 3.4.4.3 오류 수정 (필요 시)
    
    - [x] 3.5 결제 시뮬레이션 API 구현 (커밋 단위)
        - [x] 3.5.1 `app/api/transactions/simulate/route.ts` 생성
        - [x] 3.5.2 POST 핸들러 구현
            - 요청 바디 검증
            - 사용자 인증 확인
            - 사용자 패턴 조회
            - 리스크 스코어 계산
            - transactions 테이블에 저장
            - 액션 결정 (approved / voice_verification / blocked)
        - [x] 3.5.3 응답 데이터 구조 (transaction_id, risk_score, risk_level, risk_reasons, action)
        - [x] 3.5.4 시뮬레이션 API 확인
            - [x] 3.5.4.1 테스트 코드 작성 - API 엔드포인트 통합 테스트
            - [x] 3.5.4.2 테스트 실행 및 검증
            - [x] 3.5.4.3 오류 수정 (필요 시)
    
    - [x] 3.6 결과 화면 UI 구현 (커밋 단위)
        - [x] 3.6.1 리스크 점수 표시 (0-100, 색상 코드)
        - [x] 3.6.2 위험도 레벨 아이콘 및 텍스트
        - [x] 3.6.3 위험 요인 리스트 표시
        - [x] 3.6.4 액션 안내 메시지
            - "안전하게 승인되었습니다" (low)
            - "음성 확인 전화가 발신됩니다" (medium/high)
            - "즉시 차단되었습니다" (critical)
        - [x] 3.6.5 결과 화면 확인
            - [x] 3.6.5.1 테스트 코드 작성 - UI 렌더링 테스트
            - [x] 3.6.5.2 테스트 실행 및 검증
            - [x] 3.6.5.3 오류 수정 (필요 시)
    
    - [x] 3.7 결제 테스트 페이지 통합 (커밋 단위)
        - [x] 3.7.1 `app/user/payment-test/page.tsx` 생성
        - [x] 3.7.2 PaymentSimulator 컴포넌트 통합
        - [x] 3.7.3 API 호출 및 로딩 상태 처리
        - [x] 3.7.4 에러 핸들링 (네트워크 오류, 서버 오류)
        - [x] 3.7.5 결제 테스트 페이지 확인
            - [x] 3.7.5.1 테스트 코드 작성 - E2E 시뮬레이션 플로우 테스트
            - [x] 3.7.5.2 테스트 실행 및 검증
            - [x] 3.7.5.3 오류 수정 (필요 시)

# 케어페이 가디언 - 작업 목록 7: 개인 패턴 학습 및 최적화

**작업 범위**: 패턴 학습 로직, 자동 업데이트, 오탐률 개선

---

### 관련 파일
- `lib/pattern-learning.ts` - 패턴 학습 로직
- `app/api/patterns/update/route.ts` - 패턴 업데이트 API
- `supabase/functions/update-pattern/index.ts` - 패턴 업데이트 함수 (Edge Function)
- `supabase/migrations/[timestamp]_pattern_triggers.sql` - 자동 업데이트 트리거

---

## 작업

- [ ] 7.0 개인 패턴 학습 및 최적화 (Push 단위)
    - [ ] 7.1 패턴 학습 로직 구현 (커밋 단위)
        - [ ] 7.1.1 `lib/pattern-learning.ts` 파일 생성
        - [ ] 7.1.2 `updateUserPattern()` 함수 구현 (PRD 6.5 참조)
            - 최근 30일 승인된 결제 조회
            - 금액 통계 (평균, 중앙값, 최대값)
            - 시간 패턴 (common_hours, peak_hour)
            - 가맹점/업종 패턴 (TOP 3, TOP 5)
        - [ ] 7.1.3 데이터 부족 시 보수적 기본값 반환
        - [ ] 7.1.4 patterns 테이블에 UPSERT
        - [ ] 7.1.5 패턴 학습 로직 확인
            - [ ] 7.1.5.1 테스트 코드 작성 - 다양한 데이터셋 테스트
            - [ ] 7.1.5.2 테스트 실행 및 검증
            - [ ] 7.1.5.3 오류 수정 (필요 시)
    
    - [ ] 7.2 통계 계산 헬퍼 함수 (커밋 단위)
        - [ ] 7.2.1 `mean()` 함수 (평균)
        - [ ] 7.2.2 `median()` 함수 (중앙값)
        - [ ] 7.2.3 `mode()` 함수 (최빈값)
        - [ ] 7.2.4 `getFrequentValues()` 함수 (20% 이상 등장)
        - [ ] 7.2.5 `getTopN()` 함수 (상위 N개)
        - [ ] 7.2.6 통계 함수 확인
            - [ ] 7.2.6.1 테스트 코드 작성 - 각 함수별 단위 테스트
            - [ ] 7.2.6.2 테스트 실행 및 검증
            - [ ] 7.2.6.3 오류 수정 (필요 시)
    
    - [ ] 7.3 패턴 업데이트 API (커밋 단위)
        - [ ] 7.3.1 `app/api/patterns/update/route.ts` 생성
        - [ ] 7.3.2 POST 핸들러 구현
            - user_id 받기 (또는 현재 사용자)
            - updateUserPattern() 호출
            - 업데이트된 패턴 반환
        - [ ] 7.3.3 수동 업데이트 트리거 (대시보드에서 호출 가능)
        - [ ] 7.3.4 패턴 업데이트 API 확인
            - [ ] 7.3.4.1 테스트 코드 작성 - API 호출 테스트
            - [ ] 7.3.4.2 테스트 실행 및 검증
            - [ ] 7.3.4.3 오류 수정 (필요 시)
    
    - [ ] 7.4 데이터베이스 트리거 설정 (커밋 단위)
        - [ ] 7.4.1 마이그레이션 파일 생성 (`pattern_triggers.sql`)
        - [ ] 7.4.2 `update_pattern_on_approval()` 함수 생성 (PL/pgSQL)
            - 승인된 결제마다 pg_notify 발송
        - [ ] 7.4.3 트리거 생성 (AFTER UPDATE ON transactions)
        - [ ] 7.4.4 트리거 확인
            - [ ] 7.4.4.1 테스트 코드 작성 - 트리거 동작 테스트
            - [ ] 7.4.4.2 테스트 실행 및 검증
            - [ ] 7.4.4.3 오류 수정 (필요 시)
    
    - [ ] 7.5 Supabase Edge Function 구현 (커밋 단위)
        - [ ] 7.5.1 `supabase/functions/update-pattern/index.ts` 생성
        - [ ] 7.5.2 pg_notify 리스닝
        - [ ] 7.5.3 user_id 추출 후 updateUserPattern() 호출
        - [ ] 7.5.4 Edge Function 배포 (`supabase functions deploy`)
        - [ ] 7.5.5 Edge Function 확인
            - [ ] 7.5.5.1 테스트 코드 작성 - Function 실행 테스트
            - [ ] 7.5.5.2 테스트 실행 및 검증
            - [ ] 7.5.5.3 오류 수정 (필요 시)
    
    - [ ] 7.6 리스크 스코어링 로직 개선 (커밋 단위)
        - [ ] 7.6.1 `lib/risk-scoring.ts` 업데이트
        - [ ] 7.6.2 패턴 데이터를 리스크 계산에 반영
            - amountRatio 계산 (transaction.amount / pattern.avg_amount)
            - 시간대 매칭 (pattern.common_hours 확인)
            - 가맹점/업종 매칭
        - [ ] 7.6.3 오탐률 목표 10% 달성을 위한 가중치 조정
        - [ ] 7.6.4 리스크 로직 개선 확인
            - [ ] 7.6.4.1 테스트 코드 작성 - 오탐/정탐 시나리오 테스트
            - [ ] 7.6.4.2 테스트 실행 및 검증
            - [ ] 7.6.4.3 오류 수정 (필요 시)
    
    - [ ] 7.7 패턴 시각화 UI (커밋 단위)
        - [ ] 7.7.1 `app/user/patterns/page.tsx` 생성
        - [ ] 7.7.2 패턴 데이터 표시
            - 평균 결제 금액
            - 자주 사용하는 시간대 (바 차트)
            - 자주 이용하는 업종 (도넛 차트)
            - 신뢰하는 가맹점 TOP 5
        - [ ] 7.7.3 [패턴 업데이트] 버튼
        - [ ] 7.7.4 패턴 시각화 확인
            - [ ] 7.7.4.1 테스트 코드 작성 - 차트 렌더링 테스트
            - [ ] 7.7.4.2 테스트 실행 및 검증
            - [ ] 7.7.4.3 오류 수정 (필요 시)
    
    - [ ] 7.8 패턴 학습 통합 테스트 (커밋 단위)
        - [ ] 7.8.1 승인 결제 → 패턴 업데이트 → 리스크 재계산 전체 플로우
        - [ ] 7.8.2 10건 이상 결제 시뮬레이션
        - [ ] 7.8.3 오탐률 측정 (정상 결제가 차단되는 비율)
        - [ ] 7.8.4 패턴 학습 통합 확인
            - [ ] 7.8.4.1 테스트 코드 작성 - E2E 패턴 학습 플로우 테스트
            - [ ] 7.8.4.2 테스트 실행 및 검증
            - [ ] 7.8.4.3 오류 수정 (필요 시)
